#!/bin/bash

#
# This file is generated by 'bootstrap/template.py --render'
# See also bootstrap/config.py
#

set -xueo pipefail

sudo yum update -y
sudo yum install -y epel-release
sudo yum install -y yum-plugin-copr
sudo yum copr enable -y sergiomb/SambaAD
sudo yum update -y

sudo yum install -y attr bind-utils docbook-style-xsl gcc gdb krb5-workstation \
       libsemanage-python libxslt perl perl-ExtUtils-MakeMaker \
       perl-Parse-Yapp perl-Test-Base pkgconfig policycoreutils-python \
       python2-crypto gnutls-devel libattr-devel keyutils-libs-devel \
       libacl-devel libaio-devel libblkid-devel libxml2-devel openldap-devel \
       pam-devel popt-devel python-devel readline-devel zlib-devel systemd-devel \
       lmdb-devel jansson-devel gpgme-devel pygpgme libarchive-devel

sudo yum -y install autoconf automake gcc gdb krb5-devel krb5-workstation \
   openldap-devel make pam-devel python-devel docbook-style-xsl \
   libacl-devel libattr-devel libxslt 

sudo yum install -y \
    "@Development Tools" \
    acl \
    attr \
    autoconf \
    avahi-devel \
    bind-utils \
    binutils \
    bison \
    gnutls-devel \
    cups-devel \
    curl \
    dbus-devel \
    docbook-dtds \
    docbook-style-xsl \
    flex \
    gawk \
    gcc \
    gdb \
    git \
    glib2-devel \
    glibc-common \
    gpgme-devel \
    gzip \
    hostname \
    htop \
    jansson-devel \
    keyutils-libs-devel \
    krb5-devel \
    krb5-server \
    krb5-client \
    lcov \
    libacl-devel \
    libaio-devel \
    libarchive-devel \
    libattr-devel \
    libblkid-devel \
    libbsd-devel \
    libcap-devel \
    libicu-devel \
    libnsl2-devel \
    libpcap-devel \
    libsemanage-python \
    libtasn1-devel \
    libtasn1-tools \
    libtirpc-devel \
    libunwind-devel \
    libuuid-devel \
    libxslt \
    lmdb \
    lmdb-devel \
    make \
    mingw64-gcc \
    ncurses-devel \
    nettle-devel \
    openldap-devel \
    pam-devel \
    patch \
    perl-Archive-Tar \
    perl-ExtUtils-MakeMaker \
    perl-JSON-Parse \
    perl-JSON \
    perl-Parse-Yapp \
    perl-Test-Base \
    perl-core \
    perl-generators \
    perl-interpreter \
    pkgconfig \
    policycoreutils-python \
    popt-devel \
    procps-ng \
    psmisc \
    pygpgme \
    python-crypto \
    python-devel \
    python-dns \
    python-markdown \
    python36 \
    python36-crypto \
    python36-devel \
    python36-dns \
    python36-markdown \
    quota-devel \
    readline-devel \
    redhat-lsb \
    rng-tools \
    rpcgen \
    rsync \
    sed \
    sudo \
    systemd-devel \
    tar \
    tree \
    which \
    xfsprogs-devel \
    yum-utils \
    zlib-devel

sudo yum clean all

if [ ! -f /usr/bin/python3 ]; then
    sudo ln -sf /usr/bin/python3.6 /usr/bin/python3
fi

DEVICE=$(ls -l /sys/class/net | awk '$NF~/pci0/ { print $(NF-2); exit }')
IPADDR=$(ip -br address show dev $DEVICE | awk '{print substr($3,1,index($3,"/")-1);}')

mkdir samba-ad
cd samba-ad
curl -O https://download.samba.org/pub/samba/stable/samba-4.10.7.tar.gz
tar xvfz samba-4.10.7.tar.gz
cd samba-4.10.7*
./configure --disable-cups --enable-debug
make -j 2
make test
sudo make install

sudo mv /etc/krb5.conf /etc/krb5.conf.old

sudo samba-tool domain provision --server-role=dc --use-rfc2307 --dns-backend=SAMBA_INTERNAL --realm=INFRA.CO.KR --domain=INFRA --adminpass=P@ssw0rd

sudo cat <<EOF > /usr/local/samba/private/kdc.conf
[kdcdefaults]
       kdc_ports = 88
       kdc_tcp_ports = 88
       kadmind_port = 464

[realms]
       SAMDOM.EXAMPLE.COM = {
       }

        samdom.example.com = {
       }

       SAMDOM = {
	}

[dbmodules]
       # Set the following parameter to the directory
       # that contains the samba.so database module:
       db_module_dir = /usr/local/samba/lib/krb5/plugins/kdb/

       SAMDOM.EXAMPLE.COM = {
               db_library = samba
       }

       samdom.example.com = {
               db_library = samba
       }

       SAMDOM = {
               db_library = samba
       }

[logging]
       kdc = FILE:/var/log/samba/mit_kdc.log
       admin_server = FILE:/var/log/samba/mit_kadmin.log
EOF

sudo /usr/local/samba/sbin/samba-tool dns zonecreate 172.17.175.93 175.17.172.in-addr.arpa
sudo cp /usr/local/samba/private/krb5.conf /etc/krb5.conf

sudo cat <<EOF >/etc/systemd/system/samba-ad-dc.service
[Unit]
Description=Samba Active Directory Domain Controller
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
ExecStart=/usr/local/samba/sbin/samba -D
PIDFile=/usr/local/samba/var/run/samba.pid
ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target
EOF

sudo cat <<EOF >>/etc/krb5.conf
[libdefaults]
	default_realm = INFRA.CO.KR
	dns_lookup_realm = false
	dns_lookup_kdc = true
EOF

sudo cat <<EOF >>/usr/local/samba/etc/user.map
!root = SAMDOM\Administrator SAMDOM\administrator
EOF

sudo systemctl daemon-reload
sudo systemctl enable samba-ad-dc
sudo systemctl start samba-ad-dc

smbclient -L localhost -U%
smbclient //localhost/netlogon -UAdministrator -c 'ls'
kinit administrator

sudo net cache flush

sudo ln -s /usr/local/samba/lib/libnss_winbind.so.2 /lib64/
sudo ln -s /lib64/libnss_winbind.so.2 /lib64/libnss_winbind.so
sudo ln -s /usr/local/samba/lib/libnss_winbind.so.2 /lib/
sudo ln -s /lib/libnss_winbind.so.2 /lib/libnss_winbind.so
sudo ln -s /usr/local/samba/lib/security/pam_winbind.so /lib64/security/
sudo ln -s /usr/local/samba/lib/security/pam_winbind.so /lib/security/
sudo ldconfig

sudo wbinfo --ping-dc

#sudo authconfig-tui

sudo net ads join -U administrator